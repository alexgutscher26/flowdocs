name: Pull Request

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  validate:
    name: Validate PR
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR title
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert

      - name: Check for merge conflicts
        run: |
          git fetch origin ${{ github.base_ref }}
          if git merge-tree $(git merge-base HEAD origin/${{ github.base_ref }}) HEAD origin/${{ github.base_ref }} | grep -q '<<<<<<<'; then
            echo "‚ùå Merge conflicts detected"
            exit 1
          fi

  size-check:
    name: Bundle Size Check
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - name: Checkout base
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies (base)
        run: npm ci

      - name: Build base
        run: npm run build
        env:
          DATABASE_URL: postgresql://user:password@localhost:5432/test
          BETTER_AUTH_SECRET: test-secret
          BETTER_AUTH_URL: http://localhost:3000

      - name: Get base bundle size
        id: base-size
        run: |
          SIZE=$(du -sb .next | cut -f1)
          echo "size=$SIZE" >> $GITHUB_OUTPUT

      - name: Checkout PR
        uses: actions/checkout@v4

      - name: Install dependencies (PR)
        run: npm ci

      - name: Build PR
        run: npm run build
        env:
          DATABASE_URL: postgresql://user:password@localhost:5432/test
          BETTER_AUTH_SECRET: test-secret
          BETTER_AUTH_URL: http://localhost:3000

      - name: Get PR bundle size
        id: pr-size
        run: |
          SIZE=$(du -sb .next | cut -f1)
          echo "size=$SIZE" >> $GITHUB_OUTPUT

      - name: Compare sizes
        uses: actions/github-script@v7
        with:
          script: |
            const baseSize = parseInt('${{ steps.base-size.outputs.size }}');
            const prSize = parseInt('${{ steps.pr-size.outputs.size }}');
            const diff = prSize - baseSize;
            const diffPercent = ((diff / baseSize) * 100).toFixed(2);
            
            const formatBytes = (bytes) => {
              if (bytes === 0) return '0 Bytes';
              const k = 1024;
              const sizes = ['Bytes', 'KB', 'MB', 'GB'];
              const i = Math.floor(Math.log(bytes) / Math.log(k));
              return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
            };
            
            const emoji = diff > 0 ? 'üìà' : diff < 0 ? 'üìâ' : '‚û°Ô∏è';
            const sign = diff > 0 ? '+' : '';
            
            const comment = `## ${emoji} Bundle Size Report
            
            | Metric | Size |
            |--------|------|
            | Base | ${formatBytes(baseSize)} |
            | PR | ${formatBytes(prSize)} |
            | Diff | ${sign}${formatBytes(Math.abs(diff))} (${sign}${diffPercent}%) |
            
            ${Math.abs(diff) > 1024 * 1024 ? '‚ö†Ô∏è Bundle size changed by more than 1MB' : ''}`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  preview-deploy:
    name: Deploy Preview
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    environment:
      name: preview-pr-${{ github.event.pull_request.number }}
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npm run prisma:generate
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Build
        run: npm run build
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          BETTER_AUTH_SECRET: ${{ secrets.BETTER_AUTH_SECRET }}
          BETTER_AUTH_URL: ${{ secrets.BETTER_AUTH_URL }}

      - name: Deploy preview
        id: deploy
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          github-comment: true
          working-directory: ./

  label-pr:
    name: Auto-label PR
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Label PR based on files
        uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: .github/labeler.yml
